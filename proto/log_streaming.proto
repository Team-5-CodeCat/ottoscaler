syntax = "proto3";

package ottoscaler.v1;

option go_package = "github.com/Team-5-CodeCat/ottoscaler/pkg/proto/v1";

/*
 * LogStreamingService - Worker Podì—ì„œ NestJS ì„œë²„ë¡œì˜ ì‹¤ì‹œê°„ ë¡œê·¸ ìŠ¤íŠ¸ë¦¬ë° ì„œë¹„ìŠ¤
 * 
 * ğŸ¯ ëª©ì :
 * - Worker Podì˜ stdout/stderr ë¡œê·¸ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ NestJS ì„œë²„ì— ì „ì†¡
 * - ì–‘ë°©í–¥ ìŠ¤íŠ¸ë¦¬ë°ì„ í†µí•œ íš¨ìœ¨ì ì¸ ë¡œê·¸ ì „ì†¡ ë° í”¼ë“œë°± ì²˜ë¦¬
 * - Worker Pod ë“±ë¡ ë° ì„¤ì • ê´€ë¦¬
 * 
 * ğŸ“Š í†µì‹  íŒ¨í„´:
 * 1. Worker Pod ì‹œì‘ â†’ RegisterWorker() í˜¸ì¶œ â†’ ì„¸ì…˜ ì„¤ì • ë°›ê¸°
 * 2. ë¡œê·¸ ìƒì„± ì‹œë§ˆë‹¤ â†’ StreamLogs() ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì „ì†¡ â†’ ì‘ë‹µ ë°›ê¸°
 * 3. Worker Pod ì¢…ë£Œ ì‹œ â†’ ìŠ¤íŠ¸ë¦¼ ì—°ê²° ìë™ ì¢…ë£Œ
 */
service LogStreamingService {
    /*
     * StreamLogs - ì–‘ë°©í–¥ ìŠ¤íŠ¸ë¦¬ë° RPCë¡œ ë¡œê·¸ ì „ì†¡
     * 
     * ğŸ“ ë™ì‘ ë°©ì‹:
     * - Client (Worker Pod): LogEntry ë©”ì‹œì§€ë¥¼ ì§€ì†ì ìœ¼ë¡œ ì „ì†¡
     * - Server (NestJS): LogResponseë¡œ ì²˜ë¦¬ ìƒíƒœ ì‘ë‹µ
     * - ì—°ê²°ì´ ëŠì–´ì§€ë©´ ìë™ìœ¼ë¡œ ì¬ì—°ê²° ì‹œë„
     * 
     * ğŸ”„ ìŠ¤íŠ¸ë¦¼ ë¼ì´í”„ì‚¬ì´í´:
     * 1. Worker Podê°€ ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì‹œì‘
     * 2. ë¡œê·¸ ë°œìƒ ì‹œë§ˆë‹¤ LogEntry ì „ì†¡
     * 3. ì„œë²„ê°€ LogResponseë¡œ ACK/RETRY/DROP ì‘ë‹µ
     * 4. Worker ì‘ì—… ì™„ë£Œ ì‹œ ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
     */
    rpc StreamLogs(stream LogEntry) returns (stream LogResponse);
    
    /*
     * RegisterWorker - Worker Pod ì‹œì‘ ì‹œ ì„œë²„ì— ë“±ë¡
     * 
     * ğŸ“‹ ë“±ë¡ í”„ë¡œì„¸ìŠ¤:
     * 1. Worker Podê°€ ì‹œì‘ë˜ë©´ ì¦‰ì‹œ í˜¸ì¶œ
     * 2. Worker ë©”íƒ€ë°ì´í„°ì™€ ì‘ì—… ì •ë³´ ì „ì†¡
     * 3. ì„œë²„ì—ì„œ ì„¸ì…˜ IDì™€ ë¡œê¹… ì„¤ì • ë°˜í™˜
     * 4. ì´í›„ StreamLogsì—ì„œ ì„¸ì…˜ ID ì‚¬ìš©
     */
    rpc RegisterWorker(WorkerRegistration) returns (RegistrationResponse);
}

/*
 * LogEntry - Worker Podì—ì„œ ìƒì„±ë˜ëŠ” ë‹¨ì¼ ë¡œê·¸ ì—”íŠ¸ë¦¬
 * 
 * ğŸ“ ë¡œê·¸ êµ¬ì¡° ì„¤ëª…:
 * - Worker Podì˜ stdout/stderrì—ì„œ ìºì¹˜ëœ í•œ ì¤„ì˜ ë¡œê·¸ë¥¼ í‘œí˜„
 * - ì‹œê°„ ì •ë³´ì™€ í•¨ê»˜ êµ¬ì¡°í™”ëœ í˜•íƒœë¡œ ì „ì†¡
 * - NestJS ì„œë²„ì—ì„œ íŒŒì‹±í•˜ì—¬ ì›¹ ì¸í„°í˜ì´ìŠ¤ì— ì‹¤ì‹œê°„ í‘œì‹œ
 * 
 * ğŸ” ì‚¬ìš© ì˜ˆì‹œ:
 * {
 *   "worker_id": "otto-agent-1-abc123",
 *   "task_id": "task-456", 
 *   "timestamp": "2025-09-01T12:34:56.789Z",
 *   "level": "INFO",
 *   "source": "stdout",
 *   "message": "Task processing started...",
 *   "metadata": {"step": "initialization"}
 * }
 */
message LogEntry {
    // Worker Podì˜ ê³ ìœ  ì‹ë³„ì (ì˜ˆ: "otto-agent-1-abc123")
    // Main Podì—ì„œ ìƒì„±í•œ Worker Podì˜ ì´ë¦„ê³¼ ì¼ì¹˜í•´ì•¼ í•¨
    string worker_id = 1;
    
    // Redis ì´ë²¤íŠ¸ì—ì„œ ì˜¨ ì‘ì—… ì‹ë³„ì (ì˜ˆ: "task-456")
    // ì–´ë–¤ scale_up ì´ë²¤íŠ¸ë¡œ ì¸í•´ ìƒì„±ëœ ì‘ì—…ì¸ì§€ ì¶”ì 
    string task_id = 2;
    
    // ë¡œê·¸ ìƒì„± ì‹œê°„ (RFC3339 í˜•ì‹: "2025-09-01T12:34:56.789Z")
    // Worker Pod ë‚´ë¶€ì—ì„œ ë¡œê·¸ê°€ ì‹¤ì œë¡œ ë°œìƒí•œ ì‹œì 
    string timestamp = 3;
    
    // ë¡œê·¸ ë ˆë²¨ (INFO, ERROR, DEBUG, WARN ë“±)
    // ë¡œê·¸ì˜ ì¤‘ìš”ë„ë‚˜ ìœ í˜•ì„ ë‚˜íƒ€ëƒ„
    string level = 4;
    
    // ë¡œê·¸ ì†ŒìŠ¤ (stdout, stderr)
    // í‘œì¤€ ì¶œë ¥ì¸ì§€ ì—ëŸ¬ ì¶œë ¥ì¸ì§€ êµ¬ë¶„
    string source = 5;
    
    // ì‹¤ì œ ë¡œê·¸ ë©”ì‹œì§€ ë‚´ìš© (cmdì°½ì— ì¶œë ¥ë˜ëŠ” í•œ ì¤„)
    // Worker Podì˜ ì‘ì—… ì§„í–‰ ìƒí™©, ì—ëŸ¬, ë””ë²„ê·¸ ì •ë³´ ë“±
    string message = 6;
    
    // ì¶”ê°€ ë©”íƒ€ë°ì´í„° (ì„ íƒì )
    // ì‘ì—… ë‹¨ê³„, íŒŒì¼ëª…, í•¨ìˆ˜ëª… ë“± ë¶€ê°€ ì •ë³´
    map<string, string> metadata = 7;
}

/*
 * LogResponse - NestJS ì„œë²„ì—ì„œ Worker Podë¡œì˜ ì‘ë‹µ ë©”ì‹œì§€
 * 
 * ğŸ”„ ì‘ë‹µ ì²˜ë¦¬ ë¡œì§:
 * - ACK: ë¡œê·¸ ì„±ê³µì ìœ¼ë¡œ ë°›ìŒ, ë‹¤ìŒ ë¡œê·¸ ì „ì†¡ ê°€ëŠ¥
 * - RETRY: ì¼ì‹œì  ì‹¤íŒ¨, ê°™ì€ ë¡œê·¸ë¥¼ ë‹¤ì‹œ ì „ì†¡ í•„ìš”
 * - DROP: ì˜êµ¬ì  ì‹¤íŒ¨, í•´ë‹¹ ë¡œê·¸ í¬ê¸°í•˜ê³  ë‹¤ìŒìœ¼ë¡œ ì§„í–‰
 * 
 * ğŸ“Š ë°±í”„ë ˆì…”(Backpressure) ì²˜ë¦¬:
 * - ì„œë²„ ê³¼ë¶€í•˜ ì‹œ RETRY ì‘ë‹µìœ¼ë¡œ Worker Pod ì „ì†¡ ì†ë„ ì¡°ì ˆ
 * - sequence ë²ˆí˜¸ë¡œ ë¡œê·¸ ìˆœì„œ ë³´ì¥
 */
message LogResponse {
    /*
     * Status - ë¡œê·¸ ì²˜ë¦¬ ê²°ê³¼ ìƒíƒœ
     * 
     * âœ… ACK (0): ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë¨
     * ğŸ”„ RETRY (1): ì¼ì‹œì  ì˜¤ë¥˜, ì¬ì‹œë„ í•„ìš” (ë„¤íŠ¸ì›Œí¬ ì§€ì—°, ì„œë²„ ë¶€í•˜ ë“±)
     * âŒ DROP (2): ì˜êµ¬ì  ì˜¤ë¥˜, í•´ë‹¹ ë¡œê·¸ í¬ê¸° (ì˜ëª»ëœ í˜•ì‹, ê¶Œí•œ ì—†ìŒ ë“±)
     */
    enum Status {
        ACK = 0;        // ì„±ê³µì ìœ¼ë¡œ ë°›ê³  ì²˜ë¦¬í•¨
        RETRY = 1;      // ì¼ì‹œì  ì‹¤íŒ¨, ì¬ì‹œë„ ìš”ì²­
        DROP = 2;       // ì˜êµ¬ì  ì‹¤íŒ¨, ë¡œê·¸ í¬ê¸°
    }
    
    // ë¡œê·¸ ì²˜ë¦¬ ê²°ê³¼ ìƒíƒœ
    Status status = 1;
    
    // ë””ë²„ê¹…ìš© ë©”ì‹œì§€ (ì„ íƒì )
    // ì—ëŸ¬ ì´ìœ ë‚˜ ì¶”ê°€ ì •ë³´ ì œê³µ
    string message = 2;
    
    // ìˆœì„œ ë³´ì¥ì„ ìœ„í•œ ì‹œí€€ìŠ¤ ë²ˆí˜¸ (ì„ íƒì )
    // ë¡œê·¸ ì „ì†¡ ìˆœì„œì™€ ì²˜ë¦¬ ìˆœì„œ ë§¤ì¹­
    int64 sequence = 3;
}

// WorkerRegistration contains information about a starting worker
message WorkerRegistration {
    // Worker pod identifier
    string worker_id = 1;
    
    // Task identifier this worker is handling
    string task_id = 2;
    
    // Worker pod metadata
    WorkerMetadata metadata = 3;
    
    // NestJS server endpoint (for health checks)
    string server_endpoint = 4;
}

// WorkerMetadata contains Kubernetes pod information
message WorkerMetadata {
    // Pod name in Kubernetes
    string pod_name = 1;
    
    // Kubernetes namespace
    string namespace = 2;
    
    // Node where pod is running
    string node_name = 3;
    
    // Pod creation timestamp
    string created_at = 4;
    
    // Labels applied to the pod
    map<string, string> labels = 5;
}

// RegistrationResponse confirms worker registration
message RegistrationResponse {
    enum Status {
        SUCCESS = 0;
        ALREADY_REGISTERED = 1;
        SERVER_FULL = 2;
        INVALID_REQUEST = 3;
    }
    
    Status status = 1;
    string message = 2;
    
    // Server-assigned session ID for this worker
    string session_id = 3;
    
    // Recommended logging configuration
    LoggingConfig config = 4;
}

// LoggingConfig contains server preferences for logging
message LoggingConfig {
    // Maximum logs per second from this worker
    int32 rate_limit = 1;
    
    // Buffer size for batching logs
    int32 buffer_size = 2;
    
    // Maximum message size in bytes
    int32 max_message_size = 3;
    
    // Whether to include full metadata
    bool include_metadata = 4;
}