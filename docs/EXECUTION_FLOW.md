# Ottoscaler ì‹¤í–‰ íë¦„

## ğŸ”„ ëŸ°íƒ€ì„ ë™ì‘

### Main ìŠ¤ë ˆë“œ vs ê³ ë£¨í‹´

**Main ìŠ¤ë ˆë“œ (ì˜ë„ì  ë¸”ë¡œí‚¹):**
```go
func main() {
    // ... ì´ˆê¸°í™” ...
    
    // ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬ ì‹œì‘
    go handleScaleEvents(ctx, eventChan, workerManager)
    
    // Main ìŠ¤ë ˆë“œëŠ” ì¢…ë£Œ ì‹œê·¸ë„ ëŒ€ê¸° (ì˜ë„ì  ë¸”ë¡œí‚¹)
    sigChan := make(chan os.Signal, 1)
    signal.Notify(sigChan, syscall.SIGINT, syscall.SIGTERM)
    <-sigChan  // ğŸ›‘ ì‹œê·¸ë„ì„ ë°›ì„ ë•Œê¹Œì§€ ì—¬ê¸°ì„œ ë¸”ë¡œí‚¹
    
    // ìš°ì•„í•œ ì¢…ë£Œ
    cancel()
    wg.Wait()
}
```

**ì™œ Main ìŠ¤ë ˆë“œê°€ ë¸”ë¡œí‚¹ë˜ë‚˜?**
- **ëª©ì **: ì¢…ë£Œ ì‹œê·¸ë„ ëŒ€ê¸° (Kubernetesì˜ SIGTERM)
- **ì„¤ê³„**: Main ìŠ¤ë ˆë“œëŠ” ì‹œê·¸ë„ í•¸ë“¤ëŸ¬ ì—­í• ë§Œ ìˆ˜í–‰
- **ì˜í–¥**: ì²˜ë¦¬ì— ì˜í–¥ ì—†ìŒ - ëª¨ë“  ì‘ì—…ì€ ê³ ë£¨í‹´ì—ì„œ ìˆ˜í–‰

## ğŸš€ ë™ì‹œì„± ì²˜ë¦¬ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Ottoscaler Main Pod                         â”‚
â”‚                                                                 â”‚
â”‚  Main Thread              ê³ ë£¨í‹´ 1              ê³ ë£¨í‹´ 2        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ì‹œê·¸ë„   â”‚             â”‚ ì´ë²¤íŠ¸       â”‚      â”‚ Redis       â”‚ â”‚
â”‚  â”‚ í•¸ë“¤ëŸ¬   â”‚             â”‚ ì²˜ë¦¬         â”‚      â”‚ ë¦¬ìŠ¤ë„ˆ      â”‚ â”‚
â”‚  â”‚          â”‚             â”‚              â”‚      â”‚             â”‚ â”‚
â”‚  â”‚<-sigChan â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ for {        â”‚â—„â”€â”€â”€â”€â”€â”¤ XReadGroup  â”‚ â”‚
â”‚  â”‚          â”‚           â”‚ â”‚   <-eventCh  â”‚      â”‚ (2ì´ˆ ë¸”ë¡)  â”‚ â”‚
â”‚  â”‚ [BLOCK]  â”‚           â”‚ â”‚   scale_up   â”‚      â”‚             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ â”‚   scale_down â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚ â”‚ }            â”‚                     â”‚
â”‚                         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                         â”‚                                      â”‚
â”‚  ê³ ë£¨í‹´ 3,4,5...        â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                                      â”‚
â”‚  â”‚ Worker Pod 1    â”‚    â”‚                                      â”‚
â”‚  â”‚ ìƒì„±â†’ëŒ€ê¸°â†’ì‚­ì œ  â”‚â—„â”€â”€â”€â”˜                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ Worker Pod 2    â”‚                                           â”‚
â”‚  â”‚ ìƒì„±â†’ëŒ€ê¸°â†’ì‚­ì œ  â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ Worker Pod N    â”‚                                           â”‚
â”‚  â”‚ ìƒì„±â†’ëŒ€ê¸°â†’ì‚­ì œ  â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš¡ ì´ë²¤íŠ¸ ì²˜ë¦¬ íë¦„

### 1. Redis ì´ë²¤íŠ¸ ë„ì°©
```bash
# ì™¸ë¶€ íŠ¸ë¦¬ê±°
docker exec ottoscaler-redis redis-cli XADD otto:scale:events '*' type scale_up pod_count 3
```

### 2. Redis ë¦¬ìŠ¤ë„ˆ (íƒ€ì„ì•„ì›ƒ í¬í•¨ ë¹„ë¸”ë¡œí‚¹)
```go
// ê³ ë£¨í‹´ 2: Redis ë¦¬ìŠ¤ë„ˆ
go func() {
    for {
        // 2ì´ˆë§ˆë‹¤ í´ë§ (ë¸”ë¡œí‚¹ íƒ€ì„ì•„ì›ƒ, ë¬´í•œ ëŒ€ê¸° ì•„ë‹˜)
        streams, err := c.client.XReadGroup(ctx, &redis.XReadGroupArgs{
            Block: time.Second * 2,  // â° 2ì´ˆ íƒ€ì„ì•„ì›ƒ
        })
        
        if err == redis.Nil {
            continue  // ë©”ì‹œì§€ ì—†ìŒ, ë‹¤ì‹œ í´ë§
        }
        
        // íŒŒì‹± í›„ ì´ë²¤íŠ¸ ì±„ë„ë¡œ ì „ì†¡
        event := parseScaleEvent(message)
        eventChan <- event  // ğŸ“¨ ê³ ë£¨í‹´ 1ë¡œ ì „ì†¡
    }
}()
```

### 3. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì²˜ë¦¬
```go
// ê³ ë£¨í‹´ 1: ì´ë²¤íŠ¸ ì²˜ë¦¬
func handleScaleEvents(ctx, eventChan, workerManager) {
    for {
        select {
        case <-ctx.Done():
            return  // ìš°ì•„í•œ ì¢…ë£Œ
            
        case event := <-eventChan:  // ğŸ“¨ Redis ë¦¬ìŠ¤ë„ˆì—ì„œ ìˆ˜ì‹ 
            switch event.Type {
            case "scale_up":
                // ğŸš€ ë‹¤ì¤‘ Worker ê³ ë£¨í‹´ ì‹¤í–‰
                handleScaleUp(ctx, workerManager, event.PodCount, event.Metadata)
            }
        }
    }
}
```

### 4. Worker Pod ê´€ë¦¬ (ë™ì‹œì„±)
```go
func handleScaleUp(ctx, workerManager, podCount, metadata) {
    configs := createWorkerConfigs(podCount)
    
    // ğŸ¯ ëª¨ë“  Worker ë™ì‹œ ì‹œì‘
    return workerManager.RunMultipleWorkers(ctx, configs)
}

func RunMultipleWorkers(ctx, configs) {
    results := make(chan error, len(configs))
    
    // ê° Workerë¥¼ ë³„ë„ ê³ ë£¨í‹´ì—ì„œ ì‹¤í–‰
    for _, config := range configs {
        go func(cfg WorkerConfig) {
            // ê³ ë£¨í‹´ 3,4,5...: ë…ë¦½ì ì¸ Worker ê´€ë¦¬
            results <- CreateAndWaitForWorker(ctx, cfg)
        }(config)
    }
    
    // ëª¨ë“  Worker ì™„ë£Œ ëŒ€ê¸°
    for i := 0; i < len(configs); i++ {
        <-results  // ì™„ë£Œ ì‹œê·¸ë„ ìˆ˜ì§‘
    }
}
```

### 5. ê°œë³„ Worker ë¼ì´í”„ì‚¬ì´í´
```go
// ê³ ë£¨í‹´ 3,4,5...: Workerë³„ ì²˜ë¦¬
func CreateAndWaitForWorker(ctx, config) error {
    // 1. Kubernetes Pod ìƒì„±
    pod, err := m.k8sClient.CreatePod(ctx, podSpec)
    
    // 2. ì™„ë£Œ ëª¨ë‹ˆí„°ë§ (2ì´ˆ ê°„ê²© í´ë§)
    ticker := time.NewTicker(2 * time.Second)
    for {
        select {
        case <-ctx.Done():
            return ctx.Err()
        case <-ticker.C:
            pod, err := m.k8sClient.GetPod(ctx, config.Name)
            
            switch pod.Status.Phase {
            case v1.PodSucceeded:
                // 3. ì™„ë£Œëœ Pod ì •ë¦¬
                m.k8sClient.DeletePod(ctx, config.Name)
                return nil
            case v1.PodFailed:
                return fmt.Errorf("pod failed")
            case v1.PodRunning, v1.PodPending:
                // ëª¨ë‹ˆí„°ë§ ê³„ì†
                continue
            }
        }
    }
}
```

## ğŸ“Š ë¸”ë¡œí‚¹ vs ë¹„ë¸”ë¡œí‚¹ ìš”ì•½

| ì»´í¬ë„ŒíŠ¸ | ë¸”ë¡œí‚¹ íƒ€ì… | ëª©ì  | ì˜í–¥ |
|-----------|---------------|---------|--------|
| **Main ìŠ¤ë ˆë“œ** | ì˜ë„ì  ë¸”ë¡œí‚¹ | ì¢…ë£Œ ì‹œê·¸ë„ ëŒ€ê¸° | âœ… ì˜í–¥ ì—†ìŒ - ì‹œê·¸ë„ ì²˜ë¦¬ë§Œ |
| **Redis ë¦¬ìŠ¤ë„ˆ** | íƒ€ì„ì•„ì›ƒ ë¸”ë¡œí‚¹ (2ì´ˆ) | ìƒˆ ì´ë²¤íŠ¸ í´ë§ | âœ… ë¹„ë¸”ë¡œí‚¹ - í´ë§ ê³„ì† |
| **ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬** | ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ë¸”ë¡œí‚¹ | ì²˜ë¦¬í•  ì´ë²¤íŠ¸ ëŒ€ê¸° | âœ… ë¹„ë¸”ë¡œí‚¹ - ì‚¬ìš© ê°€ëŠ¥ ì‹œ ì²˜ë¦¬ |
| **Worker ëª¨ë‹ˆí„°ë§** | í´ë§ ë¸”ë¡œí‚¹ (2ì´ˆ) | Pod ì™„ë£Œ ëª¨ë‹ˆí„°ë§ | âœ… ë…ë¦½ì  - ê° Worker ë³„ë„ |

## ğŸ¯ ì£¼ìš” í†µì°°

### PodëŠ” ë¸”ë¡œí‚¹ë˜ì§€ ì•ŠìŒ
- **Main ìŠ¤ë ˆë“œëŠ” ì˜ë„ì ìœ¼ë¡œ ë¸”ë¡œí‚¹** - ì‹œê·¸ë„ ì²˜ë¦¬ë§Œ ë‹´ë‹¹
- **ëª¨ë“  ì²˜ë¦¬ëŠ” ë³„ë„ ê³ ë£¨í‹´ì—ì„œ ë™ì‹œ ìˆ˜í–‰**
- **ë‹¤ì¤‘ Workerê°€ ê°„ì„­ ì—†ì´ ë™ì‹œ ê´€ë¦¬ë¨**
- **Redis ì´ë²¤íŠ¸ëŠ” ì‚¬ìš© ê°€ëŠ¥ ì‹œ ì¦‰ì‹œ ì²˜ë¦¬**

### í™•ì¥ì„± íŠ¹ì§•
- **ì´ë²¤íŠ¸ ì²˜ë¦¬**: ë‹¤ì¤‘ ë™ì‹œ ìŠ¤ì¼€ì¼ ì´ë²¤íŠ¸ ì²˜ë¦¬ ê°€ëŠ¥
- **Worker ê´€ë¦¬**: ë¬´ì œí•œ ë™ì‹œ Worker Pod (ë¦¬ì†ŒìŠ¤ í—ˆìš© ë²”ìœ„)
- **ë¦¬ì†ŒìŠ¤ ì‚¬ìš©**: íš¨ìœ¨ì ì¸ ê³ ë£¨í‹´ ê¸°ë°˜ ë™ì‹œì„± ëª¨ë¸
- **ì‘ë‹µ ì‹œê°„**: ê±°ì˜ ì¦‰ì‹œ ì´ë²¤íŠ¸ ì²˜ë¦¬ (Kubernetes API ì œí•œ)

### ì¥ì•  ëª¨ë“œ
- **Worker Pod ì‹¤íŒ¨**: ë‹¤ë¥¸ Workerë‚˜ ë©”ì¸ ì²˜ë¦¬ì— ì˜í–¥ ì—†ìŒ
- **Redis ì—°ê²° ëŠê¹€**: ì—ëŸ¬ ë¡œê¹…ê³¼ í•¨ê»˜ ìë™ ì¬ì‹œë„
- **Kubernetes API ë¬¸ì œ**: ê°œë³„ Worker ì‹¤íŒ¨, ì‹œìŠ¤í…œì€ ê³„ì† ë™ì‘
- **ìš°ì•„í•œ ì¢…ë£Œ**: ì¢…ë£Œ ì „ ëª¨ë“  Worker ì™„ë£Œ

## ğŸ”§ ëª¨ë‹ˆí„°ë§ í¬ì¸íŠ¸

### ìƒíƒœ ì§€í‘œ
```bash
# Main Pod ìƒíƒœ í™•ì¸
kubectl get pods -l app=ottoscaler

# Worker Pod ëª¨ë‹ˆí„°ë§
kubectl get pods -l managed-by=ottoscaler

# ì²˜ë¦¬ ë¡œê·¸ í™•ì¸
kubectl logs -l app=ottoscaler -f

# Redis ì—°ê²° ìƒíƒœ
kubectl exec ottoscaler-pod -- ping redis
```

### ì„±ëŠ¥ ë©”íŠ¸ë¦­
- ì´ë²¤íŠ¸ ì²˜ë¦¬ ì§€ì—°ì‹œê°„
- Worker Pod ìƒì„± ì‹œê°„
- ë™ì‹œ Worker ìˆ˜
- Redis í´ë§ ë¹ˆë„
- Kubernetes API ì‘ë‹µ ì‹œê°„